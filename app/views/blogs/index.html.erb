<div id="navigation">
<header>
  <%= render "shared/nav" %>
</header>
<div id="subnav">
  <%= render "shared/subnav" %>
</div>
</div>

<section class="info blog news">
  
  <% @blogs.each do |blog| %>
    <div class="news-item">
      <aside>
        <h2><%= blog.created_at.strftime("%d.%m.%Y")%> </h2>
        <h2><%= blog.headline %></h2>
        <%= blog.body.html_safe %> 
      </aside>

      <article style="position: relative; display: block;">

      <!-- if multiple images in news item, do a carousel -->
        <% if blog.blogImage1_file_name and blog.blogImage2_file_name %>
        <div id="my-carousel" style="height: auto">
          <div class="carousel not-fullscreen background" style="height: auto; opacity: 1">
            <%= image_tag blog.blogImage1 %>
          </div>
          <div class="carousel not-fullscreen background">
            <%= image_tag blog.blogImage2 %>
          </div>
          <% if blog.blogImage3_file_name %>
            <div class="carousel not-fullscreen background">
              <%= image_tag blog.blogImage3 %>
            </div>
          <% end %>
          <!-- carousel navigation -->
          <p class="carousel-prev"><img src="<%= asset_path "left-arrow.svg"%>" alt="&laquo;" style="height:100%" /></p>
          <p class="carousel-next"><img src="<%= asset_path "right-arrow.svg"%>" alt="&raquo;" style="height:100%" /></p>
          <p class="indicator"></p>
        </div> <!-- end carousel -->
        <!-- else use a single news item image -->
        <% else %>
          <% if blog.blogImage1_file_name %>
            <%= image_tag blog.blogImage1 %>
          <% else %>
            <img src="<%= asset_path "about.jpg" %>" />
          <% end %>
        <% end %>

      </article>
    </div>
  <% end %>
  
 </section>

<%= will_paginate @blogs %>

<% content_for :perpagejs do %>
<script>
  var page = <%= @page %>;
  $(function() {
  
    $('footer').appear();

    $(document.body).on('appear', 'footer', function(e) {
      var $this = $(this);
      if ($this.data('am-i-appeared')) {
        return;
      }
      $this.data('am-i-appeared', true);
      page++;

      // get paginated news items
      $.get('/news.json?page=' + page, function(resp){
        history.replaceState(null, null, "/news?page=" + page);

        for(var i = 0; i < resp.length; i++) {

          var img1 = img2 = img3 = "";
          var images = "";
          var buttons = "";

          if (resp[i].blogImage1) {
            img1 = '<img src="'+resp[i].blogImage1+'" />';
          } else {
            img1 = '<img src="<%= asset_path "about.jpg" %>" />';
          }
          if (resp[i].blogImage2) {
            img2 = '<div class="carousel not-fullscreen background"><img src="'+resp[i].blogImage2+'" /></div>';
          }
          if (resp[i].blogImage3) {
            img3 = '<div class="carousel not-fullscreen background"><img src="'+resp[i].blogImage3+'" /></div>';
          }

          if (img1 && img2) {
            images = '<div id="my-carousel" style="height: auto"><div class="carousel active not-fullscreen background"><img src="'+resp[i].blogImage1+'" /></div>'+img2+img3+'</div>';
            buttons = '<p class="carousel-prev"><img src="<%= asset_path "left-arrow.svg"%>" alt="&laquo;" style="height:100%" /></p><p class="carousel-next"><img src="<%= asset_path "right-arrow.svg"%>" alt="&raquo;" style="height:100%" /></p><p class="indicator"></p>';
          } else {
            images = img1;
          }

          $('<div class="news-item" style="opacity:0;"><aside><h2>' + resp[i].created_at + '</h2><h2>' + resp[i].headline + '</h2>' + resp[i].body + '</aside><article style="position: relative; display: block;">'+images+buttons+'</article></div>').appendTo('section').animate({ opacity : 1 }, 1500);

        }
        if(resp.length < 3) {
          $this.data('am-i-appeared', true);
        } else {
          $this.data('am-i-appeared', false);
        }

        // run carousel on new items
        var pp = (page*3)-4;
        $('.news-item:gt('+pp+') #my-carousel').each(doCarousel);

      });

    });
  });
</script>
<% end %>

