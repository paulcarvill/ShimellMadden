<% content_for :perpageclass do %>archive <% end %>

<section class="blog archive">
  <aside>
    <h2>Archive</h2>

    <ul class="category-nav">
    <li>Category <svg class="status" x="0px" y="0px"
   viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
<path d="M14,28C6.3,28,0,21.7,0,14S6.3,0,14,0s14,6.3,14,14S21.7,28,14,28z M14,2C7.4,2,2,7.4,2,14
  c0,6.6,5.4,12,12,12c6.6,0,12-5.4,12-12C26,7.4,20.6,2,14,2z"/><rect x="7" y="13" width="14" height="2"/><rect x="13" y="7" width="2" height="14"/></svg>

      <ul <%= if params['category'] == nil then raw('style="display: none"') end %>>
      <% @categories.each do |category| %>
        <li><a href="?category=<%= category.id %>" <%= if category.id.to_s == params['category'] then raw("class='current'") end %>><%= category.name %></a><%= if category.id.to_s == params['category'] then raw('<a style="float:right" class="current" href="/archive"><svg id="icon-search_active_idle" x="0px" y="0px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve"><g><path d="M14,0C6.3,0,0,6.3,0,14s6.3,14,14,14s14-6.3,14-14S21.7,0,14,0z M14,26C7.4,26,2,20.6,2,14 C2,7.4,7.4,2,14,2s12,5.4,12,12C26,20.6,20.6,26,14,26z"/><polygon points="18.8,7.8 14,12.6 9.2,7.8 7.8,9.2 12.6,14 7.8,18.8 9.2,20.2 14,15.4 18.8,20.2 20.2,18.8 15.4,14 20.2,9.2  "/></g></svg></a>') end %></li>
      <% end %>
      </ul>
    </li>
    <li>Date <svg class="status" x="0px" y="0px"
   viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
<path d="M14,28C6.3,28,0,21.7,0,14S6.3,0,14,0s14,6.3,14,14S21.7,28,14,28z M14,2C7.4,2,2,7.4,2,14
  c0,6.6,5.4,12,12,12c6.6,0,12-5.4,12-12C26,7.4,20.6,2,14,2z"/><rect x="7" y="13" width="14" height="2"/><rect x="13" y="7" width="2" height="14"/></svg>
      <ul <%= if params['date'] == nil then raw('style="display: none"') end %>>
        <% @months.each do | month | %>
          <li><a href="?date=<%= month %>" <%= if month == params['date'] then raw("class='current'") end %>><%= month %></a><%= if month == params['date'] then raw('<a style="float:right" class="current" href="/archive">&times;</a>') end %></li>
        <% end %>
      </ul>
    </li>
    </ul>
  </aside>

  <article>
    <% @items.each_with_index do |item, index| %>
      <div class="archive-item">
        <div class="table" style="width: 100%;">
            <div style="display: inline-block; position: relative; width: 100%;">
              <a href="/archive/<%= item.id %>"><div class="image" style="display: block; height: 100%; width: 100%; background-image: url(<%= asset_path item.img_url_large %>); margin: 0 auto; height: 200px; background-size: cover; background-repeat: no-repeat;  background-position: 50% <%= if item.weight == 0 then "50%" elsif item.weight ==  1 then "0" else "100%" end %>" /></div></a>
              <!-- info overlay -->
              <a class="overlaylink" href="/archive/<%= item.id %>">
                <div class="item-overlay">
                  <div class="tc">
                    <span><%= item.name %></span>
                    <hr/>
                    <%= if item.date? then item.date.strftime("%Y") else item.created_at.strftime("%Y") end %>
                  </div>
                </div>
              </a>
            </div>
        </div>
      </div>
    <% end %>
  </article>
</section>

<%= will_paginate @items %>

<% content_for :perpagejs do %>
<script>
$(function(){
  var toggle = 0;
  $('.category-nav>li').click(function(){
    $(this).toggleClass('open');
    $(this).closest('li').find('ul').toggle();
  })

  // only do this for non-touch devices because it's hover behaviour
  $('.table div img.image').on('hover', function(){
      $(this).next('.item-overlay').data('my-height', $(this).height());
      $(this).next('.item-overlay').css('height', $(this).height());
  })
})

/* 
 *  this is for infinite scroll
*/
var page = 1;
var item = 6;
var assTri = '<%= asset_path 'down-triangle.svg' %>';
var weights = [50, 0, 100];

function getItems(pageNumber) {
  $.get('/archive.json?page=' + page, function(resp){

    for(var i = 0; i < resp.length; i++) {
      
      // when response arrives, hide progeress indicator
      $('article img.progress').animate({ opacity : 0 }, function(){
        this.remove();
      })
      
      // add new archive items to page 
      $('<div class="archive-item"><div class="table"><div style="display: inline-block; position: relative; width: 100%">' + 
        '<a href="/archive/' + resp[i].id + '">' +

        '<div class="image" style="display: block; height: 100%; width: 100%; background-image: url('+resp[i].small+'); margin: 0 auto; height: 200px; background-size: cover; background-repeat: no-repeat;  background-position: 50%  ' + (item.weight == 0 ? "50%" : item.weight ==  1 ? "0" : "100%") + '" /></div>' +


        '</a>' +
        '<a class="overlaylink" href="/archive/' + resp[i].id + '"><div class="item-overlay"><div class="tc">' + 
        '<span>' + resp[i].name + '</span><hr/>' +
        (resp[i].date ? new Date(resp[i].date).getFullYear() : new Date(resp[i].created_at).getFullYear()) +
        '</div>' + 
        '</div></div></a></div></div></div>').appendTo($('article')).animate({ opacity : 1 }, 1500);
    }

    if(resp.length < 9) {
      $('footer').data('am-i-appeared', true);
    } else {
      $('footer').data('am-i-appeared', false);
    }

    item += resp.length;
  });
}


// this sets up the element we watch to check when it enters the viewport
// so we can load more content. in our case it's the footer
$('document').ready(function() {

  $('footer').appear();

  $(document.body).on('appear', 'footer', function(e) {
    var $this = $(this);
    if ($this.data('am-i-appeared')) {
      return;
    }
    $this.data('am-i-appeared', true);
    page++;
    getItems(page);
  });

});  


</script>
<% end %>